<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayFast Checkout - Teien Tamashii</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .cart-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            margin-top: 0;
        }
        .cart-list {
            margin: 20px 0;
            border-collapse: collapse;
            width: 100%;
        }
        .cart-list th, .cart-list td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .cart-list th {
            background: #f0f0f0;
        }
        .cart-total {
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            margin-top: 10px;
        }
        .delivery-info {
            background: #f9f9f9;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0 10px 0;
            font-size: 1em;
        }
        .delivery-info strong {
            color: #bc002d;
        }
        .checkout-btn {
            background: #bc002d;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            margin-top: 20px;
            width: 100%;
            transition: background 0.3s;
        }
        .checkout-btn:hover {
            background: #8b0000;
        }
        .empty-cart {
            color: #888;
            text-align: center;
            margin: 30px 0;
        }
    </style>
</head>
<body>
    <div class="cart-container">
        <h1>Checkout</h1>
        <table class="cart-list" id="cart-list">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price (R)</th>
                    <th>Subtotal (R)</th>
                </tr>
            </thead>
            <tbody id="cart-items"></tbody>
        </table>
        <div class="empty-cart" id="empty-cart" style="display:none;">Your cart is empty.</div>
        <div class="delivery-info" id="delivery-info" style="display:none;"></div>
        <div class="cart-total" id="cart-total"></div>
        <button class="checkout-btn" id="checkout-btn">Checkout with PayFast</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
    <script>
        // PayFast Configuration (SANDBOX)
        const PAYFAST_CONFIG = {
            merchant_id: "10000100",
            merchant_key: "46f0cd694581a",
            endpoint: "https://sandbox.payfast.co.za/eng/process",
            passphrase: "" // Leave blank unless you set a passphrase in your PayFast dashboard
        };

        // Load cart from localStorage (same structure as your main site)
        function loadCart() {
            try {
                const cart = JSON.parse(localStorage.getItem('cartItems')) || [];
                return Array.isArray(cart) ? cart : [];
            } catch {
                return [];
            }
        }

        // Load delivery info from localStorage (example structure)
        function loadDeliveryInfo() {
            try {
                return JSON.parse(localStorage.getItem('deliveryAddress')) || null;
            } catch {
                return null;
            }
        }

        function renderCart(cart, delivery) {
            const cartItemsTbody = document.getElementById('cart-items');
            const cartTotalDiv = document.getElementById('cart-total');
            const emptyCartDiv = document.getElementById('empty-cart');
            const deliveryInfoDiv = document.getElementById('delivery-info');
            cartItemsTbody.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                emptyCartDiv.style.display = 'block';
                cartTotalDiv.textContent = '';
                deliveryInfoDiv.style.display = 'none';
                document.getElementById('checkout-btn').disabled = true;
                return;
            } else {
                emptyCartDiv.style.display = 'none';
                document.getElementById('checkout-btn').disabled = false;
            }

            cart.forEach(item => {
                const qty = item.quantity || 1;
                const price = parseFloat(item.price || 0);
                const subtotal = qty * price;
                total += subtotal;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.title || item.name || 'Item'}</td>
                    <td>${qty}</td>
                    <td>${price.toFixed(2)}</td>
                    <td>${subtotal.toFixed(2)}</td>
                `;
                cartItemsTbody.appendChild(tr);
            });

            // Show delivery info if available
            let deliveryCost = 0;
            if (delivery && delivery.cost) {
                deliveryCost = parseFloat(delivery.cost) || 0;
                deliveryInfoDiv.style.display = 'block';
                deliveryInfoDiv.innerHTML = `
                    <div><strong>Delivery Location:</strong> ${delivery.location || delivery.fullAddress || 'N/A'}</div>
                    <div><strong>Zone:</strong> ${delivery.zone || delivery.deliveryZone || 'N/A'}</div>
                    <div><strong>Estimated Time:</strong> ${delivery.estimated || delivery.estimatedDeliveryTime || 'N/A'}</div>
                    <div><strong>Delivery Cost:</strong> R${deliveryCost.toFixed(2)}</div>
                `;
            } else {
                deliveryInfoDiv.style.display = 'none';
            }

            cartTotalDiv.textContent = `Total: R${(total + deliveryCost).toFixed(2)}`;
        }

        // FIXED: Generate PayFast signature (spaces as %20, only non-empty fields, alphabetical order, no signature field)
        function generatePayFastSignature(data, passphrase = '') {
            const keys = Object.keys(data)
                .filter(key => data[key] !== '' && data[key] !== undefined && data[key] !== null && key !== 'signature')
                .sort();
            let pfString = keys
                .map(key => key + '=' + encodeURIComponent(data[key]))
                .join('&');
            if (passphrase) {
                pfString += '&passphrase=' + encodeURIComponent(passphrase);
            }
            return md5(pfString);
        }

        // On checkout, submit to PayFast
        function checkout(cart, delivery) {
            if (!cart.length) return;

            // Prepare item_name and description
            const itemNames = cart.map(item => (item.title || item.name || 'Item') + (item.quantity > 1 ? ` x${item.quantity}` : '')).join(', ');
            const itemDescription = cart.map(item => (item.title || item.name || 'Item')).join(', ');
            const itemsTotal = cart.reduce((sum, item) => sum + (parseFloat(item.price || 0) * (item.quantity || 1)), 0);
            const deliveryCost = delivery && delivery.cost ? parseFloat(delivery.cost) : 0;
            const total = itemsTotal + deliveryCost;

            // Prepare PayFast data
            const paymentData = {
                merchant_id: PAYFAST_CONFIG.merchant_id,
                merchant_key: PAYFAST_CONFIG.merchant_key,
                amount: total.toFixed(2),
                item_name: itemNames.slice(0, 100), // PayFast limit
                item_description: itemDescription.slice(0, 255),
                return_url: `${window.location.origin}/success.html`,
                cancel_url: `${window.location.origin}/payfast-test.html?cancelled=true`,
                notify_url: `${window.location.origin}/payfast-notify.php`,
                name_first: "Customer",
                name_last: "Checkout",
                email_address: "test@example.com",
                m_payment_id: `ORDER_${Date.now()}`
            };

            // Generate signature
            paymentData.signature = generatePayFastSignature(paymentData, PAYFAST_CONFIG.passphrase);

            // Create and submit form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = PAYFAST_CONFIG.endpoint;
            form.target = '_blank';

            Object.keys(paymentData).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = paymentData[key];
                form.appendChild(input);
            });

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
        }

        // Main
        const cart = loadCart();
        const delivery = loadDeliveryInfo();
        renderCart(cart, delivery);

        document.getElementById('checkout-btn').onclick = function() {
            checkout(cart, delivery);
        };
    </script>
</body>
</html>
